name: Identity Strict Validator

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq tidy libxml2-utils

      # -------------------------
      # JSON VALIDATION
      # -------------------------
      - name: Validate all JSON files
        run: |
          set -e
          find . -type f -name "*.json" ! -path "./.git/*" | while read f; do
            jq empty "$f"
          done

      # -------------------------
      # NDJSON VALIDATION
      # -------------------------
      - name: Validate all NDJSON files
        run: |
          set -e
          find . -type f -name "*.ndjson" ! -path "./.git/*" | while read f; do
            while IFS= read -r line; do
              echo "$line" | jq empty
            done < "$f"
          done

      # -------------------------
      # XML VALIDATION
      # -------------------------
      - name: Validate all XML files
        run: |
          set -e
          find . -type f -name "*.xml" ! -path "./.git/*" | while read f; do
            xmllint --noout "$f"
          done

      # -------------------------
      # HTML VALIDATION
      # -------------------------
      - name: Validate all HTML files (strict)
        run: |
          set -e
          find . -type f -name "*.html" ! -path "./.git/*" | while read f; do
            tidy -errors -q "$f"
          done

      # -------------------------
      # EMPTY FILE CHECK
      # -------------------------
      - name: Check empty files
        run: |
          set -e
          find . -type f ! -path "./.git/*" | while read f; do
            if [ ! -s "$f" ]; then
              echo "Empty file: $f"
              exit 1
            fi
          done

      # -------------------------
      # API DIRECTORY CHECK
      # -------------------------
      - name: Validate API structure
        run: |
          set -e

          if [ -d "api" ]; then
            API_COUNT=$(find api -type f -name "*.json" | wc -l)
            if [ "$API_COUNT" -eq 0 ]; then
              echo "API directory exists but contains no JSON files"
              exit 1
            fi
          fi

      # -------------------------
      # MACHINE HASH VALIDATION
      # -------------------------
      - name: Validate all SHA256 integrity pairs
        run: |
          set -e

          find . -type f -name "*.sha256" ! -path "./.git/*" | while read hashfile; do

            target="${hashfile%.sha256}"

            if [ ! -f "$target" ]; then
              echo "Missing target file for hash: $hashfile"
              exit 1
            fi

            sed -i 's/\r$//' "$target"

            CALCULATED=$(sha256sum "$target" | awk '{print $1}')
            STORED=$(tr -d '\r\n ' < "$hashfile")

            echo "Checking $target"

            if [ "$CALCULATED" != "$STORED" ]; then
              echo "SHA256 mismatch for $target"
              exit 1
            fi

          done

          echo "All SHA256 files valid"

      - name: Final status
        run: echo "Identity validation passed"
