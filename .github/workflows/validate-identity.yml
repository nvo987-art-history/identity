name: Identity Strict Validator

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (FULL DEPTH)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show repository structure (debug)
        run: |
          echo "Workspace: $GITHUB_WORKSPACE"
          echo "Total files:"
          find "$GITHUB_WORKSPACE" -type f | wc -l
          echo "Top level structure:"
          ls -la "$GITHUB_WORKSPACE"

      - name: Install validation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      ########################################
      # JSON VALIDATION
      ########################################
      - name: Validate ALL JSON files
        run: |
          set -e
          echo "Validating JSON files..."
          find "$GITHUB_WORKSPACE" -type f -name "*.json" ! -path "*/.git/*" | while read file; do
            echo "Checking $file"
            jq empty "$file"
          done
          echo "JSON validation complete."

      ########################################
      # JSON-LD VALIDATION
      ########################################
      - name: Validate ALL JSON-LD files
        run: |
          set -e
          echo "Validating JSON-LD files..."
          find "$GITHUB_WORKSPACE" -type f -name "*.jsonld" ! -path "*/.git/*" | while read file; do
            echo "Checking $file"
            jq empty "$file"
          done
          echo "JSON-LD validation complete."

      ########################################
      # HTML BASIC STRUCTURE CHECK
      ########################################
      - name: Validate ALL HTML files (basic structure)
        run: |
          set -e
          echo "Validating HTML files..."
          find "$GITHUB_WORKSPACE" -type f -name "*.html" ! -path "*/.git/*" | while read file; do
            echo "Checking $file"
            grep -q "<html" "$file"
            grep -q "</html>" "$file"
          done
          echo "HTML validation complete."

      ########################################
      # SHA256 Integrity Check (optional)
      ########################################
      - name: Generate SHA256 for all files
        run: |
          echo "Generating SHA256 for all files..."
          find "$GITHUB_WORKSPACE" -type f ! -path "*/.git/*" -exec sha256sum {} \; > sha256-manifest.txt
          echo "SHA256 manifest created."

      - name: Upload SHA256 manifest
        uses: actions/upload-artifact@v4
        with:
          name: sha256-manifest
          path: sha256-manifest.txt
