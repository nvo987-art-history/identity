name: ULTRA Site + AI + SEO + Security Validation

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # -------------------------------------------------
      # Install tools
      # -------------------------------------------------
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq xmllint html-xml-utils poppler-utils curl

      # -------------------------------------------------
      # JSON validation
      # -------------------------------------------------
      - name: Validate JSON
        run: |
          for f in $(find . -name "*.json"); do
            echo "Checking $f"
            jq empty "$f"
          done

      # -------------------------------------------------
      # XML validation
      # -------------------------------------------------
      - name: Validate XML
        run: |
          for f in $(find . -name "*.xml"); do
            echo "Checking $f"
            xmllint --noout "$f"
          done

      # -------------------------------------------------
      # HTML validation
      # -------------------------------------------------
      - name: Validate HTML
        run: |
          for f in $(find . -name "*.html"); do
            echo "Checking $f"
            hxnormalize -x "$f" > /dev/null
          done

      # -------------------------------------------------
      # Required files
      # -------------------------------------------------
      - name: Check required files
        run: |
          test -f robots.txt
          test -f sitemap.xml
          test -f schema.jsonld
          test -f llms.txt

      # -------------------------------------------------
      # schema.org presence
      # -------------------------------------------------
      - name: Check schema.org presence
        run: |
          grep -qi "schema.org" schema.jsonld

      # -------------------------------------------------
      # robots / llms format
      # -------------------------------------------------
      - name: Validate robots/llms format
        run: |
          grep -q "User-Agent" robots.txt
          grep -q "User-Agent" llms.txt

      # -------------------------------------------------
      # Broken links
      # -------------------------------------------------
      - name: Check broken links
        run: |
          urls=$(grep -rhoE 'https://[^"]+' . | sort -u)
          for u in $urls; do
            echo "Testing $u"
            curl -sfL "$u" > /dev/null
          done

      # -------------------------------------------------
      # Test sitemap URLs
      # -------------------------------------------------
      - name: Test sitemap URLs
        run: |
          grep -oP '(?<=<loc>).*?(?=</loc>)' sitemap.xml | while read url; do
            echo "Testing $url"
            curl -sfL "$url" > /dev/null
          done

      # -------------------------------------------------
      # PDF readable
      # -------------------------------------------------
      - name: Check PDFs readable
        run: |
          for f in $(find . -name "*.pdf"); do
            echo "PDF: $f"
            pdftotext "$f" - > /dev/null
          done

      # -------------------------------------------------
      # Duplicate filenames (FIXED .git excluded)
      # -------------------------------------------------
      - name: Check duplicates
        run: |
          dup=$(find . -path ./.git -prune -o -type f -exec basename {} \; | sort | uniq -d)
          if [ ! -z "$dup" ]; then
            echo "Duplicate filenames:"
            echo "$dup"
            exit 1
          fi

      # -------------------------------------------------
      # File size limit (10MB)
      # -------------------------------------------------
      - name: Check file sizes
        run: |
          big=$(find . -type f -size +10M)
          if [ ! -z "$big" ]; then
            echo "$big"
            exit 1
          fi

      # -------------------------------------------------
      # Generate SHA256 checksums
      # -------------------------------------------------
      - name: Generate SHA256 checksums
        run: |
          find . -type f -not -path "./.git/*" -exec sha256sum {} \; > SHA256SUMS.txt

      # -------------------------------------------------
      # Generate AI dataset
      # -------------------------------------------------
      - name: Generate AI dataset
        run: |
          mkdir -p ai_dataset
          find . \( -name "*.json" -o -name "*.xml" -o -name "*.txt" -o -name "*.pdf" \) -not -path "./.git/*" -exec cp {} ai_dataset/ \;

      # -------------------------------------------------
      # Upload artifact
      # -------------------------------------------------
      - uses: actions/upload-artifact@v4
        with:
          name: validation-artifacts
          path: |
            SHA256SUMS.txt
            ai_dataset
