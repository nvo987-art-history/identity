name: ultra-validate

on:
  push:
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # =========================
      # INSTALL (FIXED)
      # =========================
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            tidy \
            jq \
            libxml2-utils \
            linkchecker \
            curl

          npm install -g lighthouse

      # =========================
      # HTML
      # =========================
      - name: Validate HTML
        run: |
          find . -name "*.html" -exec tidy -qe {} \;

      # =========================
      # JSON
      # =========================
      - name: Validate JSON
        run: |
          find . -name "*.json" -exec jq empty {} \;

      # =========================
      # XML
      # =========================
      - name: Validate XML
        run: |
          find . -name "*.xml" -exec xmllint --noout {} \;

      # =========================
      # Required files
      # =========================
      - name: Required files
        run: |
          test -f index.html
          test -f sitemap.xml
          test -f robots.txt
          test -f llms.txt

      # =========================
      # schema.org check
      # =========================
      - name: Require schema.org JSON-LD
        run: |
          grep -R '"@context": "https://schema.org"' . || exit 1

      # =========================
      # Broken links
      # =========================
      - name: Broken links check
        run: |
          linkchecker index.html --no-status

      # =========================
      # Homepage online
      # =========================
      - name: Homepage status
        run: |
          curl -f https://identity.nv0987.us

      # =========================
      # API endpoints
      # =========================
      - name: API endpoints
        run: |
          curl -f https://identity.nv0987.us/sitemap.xml
          curl -f https://identity.nv0987.us/llms.txt

      # =========================
      # Lighthouse SEO
      # =========================
      - name: Lighthouse SEO audit
        run: |
          lighthouse https://identity.nv0987.us \
            --chrome-flags="--headless" \
            --only-categories=seo \
            --quiet \
            --output=json \
            --output-path=lighthouse.json

          score=$(jq '.categories.seo.score' lighthouse.json)
          echo "SEO score: $score"
          awk "BEGIN {exit !($score >= 0.9)}"

      # =========================
      # Checksums
      # =========================
      - name: Generate checksums
        run: |
          find . -type f -exec sha256sum {} \; > checksums.txt

      # =========================
      # Save reports
      # =========================
      - uses: actions/upload-artifact@v4
        with:
          name: validation-reports
          path: |
            lighthouse.json
            checksums.txt
