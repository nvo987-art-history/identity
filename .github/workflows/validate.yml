name: ultra-validate

on:
  push:
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # -------------------------
      # Install tools
      # -------------------------
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y tidy jq xmllint linkchecker curl
          npm install -g lighthouse

      # -------------------------
      # HTML
      # -------------------------
      - name: Validate HTML
        run: |
          find . -name "*.html" -print0 | while IFS= read -r -d '' f; do
            tidy -qe "$f"
          done

      # -------------------------
      # JSON
      # -------------------------
      - name: Validate JSON
        run: |
          find . -name "*.json" -print0 | while IFS= read -r -d '' f; do
            jq empty "$f"
          done

      # -------------------------
      # XML
      # -------------------------
      - name: Validate XML
        run: |
          find . -name "*.xml" -print0 | while IFS= read -r -d '' f; do
            xmllint --noout "$f"
          done

      # -------------------------
      # Required core files
      # -------------------------
      - name: Required files
        run: |
          test -f index.html
          test -f sitemap.xml
          test -f robots.txt
          test -f llms.txt

      # -------------------------
      # schema.org required
      # -------------------------
      - name: Require schema.org JSON-LD
        run: |
          grep -R '"@context": "https://schema.org"' . || (echo "Missing schema.org metadata" && exit 1)

      # -------------------------
      # Link check
      # -------------------------
      - name: Broken links check
        run: |
          linkchecker index.html --no-status

      # -------------------------
      # Homepage live
      # -------------------------
      - name: Homepage status
        run: |
          curl -f https://identity.nv0987.us

      # -------------------------
      # API endpoints
      # -------------------------
      - name: API endpoints
        run: |
          curl -f https://identity.nv0987.us/sitemap.xml
          curl -f https://identity.nv0987.us/llms.txt

      # -------------------------
      # Lighthouse SEO
      # -------------------------
      - name: Lighthouse audit
        run: |
          lighthouse https://identity.nv0987.us \
            --quiet \
            --chrome-flags="--headless" \
            --only-categories=seo \
            --output=json \
            --output-path=lighthouse.json

          score=$(jq '.categories.seo.score' lighthouse.json)
          echo "SEO score: $score"
          awk "BEGIN {exit !($score >= 0.9)}"

      # -------------------------
      # Checksums
      # -------------------------
      - name: Generate checksums
        run: |
          find . -type f -exec sha256sum {} \; > checksums.txt

      # -------------------------
      # Save reports
      # -------------------------
      - uses: actions/upload-artifact@v4
        with:
          name: validation-reports
          path: |
            lighthouse.json
            checksums.txt
