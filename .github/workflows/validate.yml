name: Brutal Site Validate PRO

on:
  push:
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # -------------------------------------------------
      # Install tools
      # -------------------------------------------------
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq libxml2-utils curl poppler-utils

      # -------------------------------------------------
      # JSON validate
      # -------------------------------------------------
      - name: Validate JSON
        run: |
          find . -name "*.json" -type f -print0 | while IFS= read -r -d '' f; do
            echo "JSON $f"
            jq empty "$f" || exit 1
          done

      # -------------------------------------------------
      # XML validate
      # -------------------------------------------------
      - name: Validate XML
        run: |
          find . -name "*.xml" -type f -print0 | while IFS= read -r -d '' f; do
            echo "XML $f"
            xmllint --noout "$f" || exit 1
          done

      # -------------------------------------------------
      # HTML validate
      # -------------------------------------------------
      - name: Validate HTML
        run: |
          find . -name "*.html" -type f -print0 | while IFS= read -r -d '' f; do
            echo "HTML $f"
            xmllint --html --noout "$f" || true
          done

      # -------------------------------------------------
      # PDF readable
      # -------------------------------------------------
      - name: Validate PDFs
        run: |
          find . -name "*.pdf" -type f -print0 | while IFS= read -r -d '' f; do
            echo "PDF $f"
            pdftotext "$f" /dev/null || exit 1
          done

      # -------------------------------------------------
      # Required files (strict)
      # -------------------------------------------------
      - name: Required files
        run: |
          test -f robots.txt || exit 1
          test -f llms.txt || exit 1
          test -f sitemap.xml || exit 1

      # -------------------------------------------------
      # schema.org required
      # -------------------------------------------------
      - name: Require schema.org
        run: |
          grep -r "schema.org" . >/dev/null || exit 1

      # -------------------------------------------------
      # robots/llms format
      # -------------------------------------------------
      - name: Validate robots/llms format
        run: |
          grep -E "User-Agent:" robots.txt llms.txt >/dev/null || exit 1

      # -------------------------------------------------
      # BLOCK REAL HTTP links ONLY (SMART)
      # -------------------------------------------------
      - name: Block insecure HTTP links
        run: |
          bad=$(grep -rhoE '(href|src)="http://[^"]+"' . \
            --include=\*.html --include=\*.xml --include=\*.txt || true)

          if [ ! -z "$bad" ]; then
            echo "INSECURE HTTP links found:"
            echo "$bad"
            exit 1
          fi

      # -------------------------------------------------
      # Broken links test
      # -------------------------------------------------
      - name: Check broken links
        run: |
          set +e
          urls=$(grep -rhoE 'https://[A-Za-z0-9._~:/?#@!$&()*+,;=%-]+' . | sort -u)

          for u in $urls; do
            echo "Testing $u"
            curl -Is --max-time 10 "$u" >/dev/null
          done

          exit 0

      # -------------------------------------------------
      # Sitemap URLs test
      # -------------------------------------------------
      - name: Test sitemap URLs
        run: |
          if [ -f sitemap.xml ]; then
            urls=$(grep -oP '(?<=<loc>).*?(?=</loc>)' sitemap.xml)
            for u in $urls; do
              echo "Testing $u"
              curl -Is --max-time 10 "$u" >/dev/null
            done
          fi

      # -------------------------------------------------
      # File size limit (1MB strict)
      # -------------------------------------------------
      - name: Check file sizes
        run: |
           find . -type f -size +10M ! -path "./.git/*" -print || true 

      # -------------------------------------------------
      # SHA256 generate
      # -------------------------------------------------
      - name: Generate SHA256 checksums
        run: |
          find . -type f ! -path "./.git/*" -exec sha256sum {} \; > checksums.sha256

      # -------------------------------------------------
      # Build AI dataset
      # -------------------------------------------------
      - name: Generate AI dataset
        run: |
          mkdir -p ai_dataset
          find . \( -name "*.json" -o -name "*.xml" -o -name "*.txt" -o -name "*.html" \) \
            -exec cp {} ai_dataset/ \; 2>/dev/null || true
          tar -czf ai_dataset.tar.gz ai_dataset

      # -------------------------------------------------
      # Upload artifacts
      # -------------------------------------------------
      - uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            checksums.sha256
            ai_dataset.tar.gz
