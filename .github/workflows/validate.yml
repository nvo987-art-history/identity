name: Validate site (AI + SEO + Integrity PRO)

on:
  push:
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      # -----------------------
      # Checkout
      # -----------------------
      - uses: actions/checkout@v4

      # -----------------------
      # Install tools
      # -----------------------
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq libxml2-utils curl poppler-utils

      # =========================================================
      # FILE VALIDATION
      # =========================================================

      # JSON
      - name: Validate JSON
        run: |
          find . -name "*.json" -type f -print0 | while IFS= read -r -d '' f; do
            echo "JSON → $f"
            jq empty "$f" || exit 1
          done

      # XML
      - name: Validate XML
        run: |
          find . -name "*.xml" -type f -print0 | while IFS= read -r -d '' f; do
            echo "XML → $f"
            xmllint --noout "$f" || exit 1
          done

      # HTML
      - name: Validate HTML
        run: |
          find . -name "*.html" -type f -print0 | while IFS= read -r -d '' f; do
            echo "HTML → $f"
            xmllint --html --noout "$f" || true
          done

      # PDFs readable
      - name: Validate PDFs
        run: |
          find . -name "*.pdf" -type f -print0 | while IFS= read -r -d '' f; do
            echo "PDF → $f"
            pdftotext "$f" /dev/null || echo "Unreadable PDF (warning)"
          done

      # =========================================================
      # REQUIRED FILES
      # =========================================================

      - name: Check required files
        run: |
          for f in robots.txt llms.txt sitemap.xml; do
            if [ ! -f "$f" ]; then
              echo "$f missing"
              exit 1
            fi
          done

      # =========================================================
      # SEO + AI
      # =========================================================

      - name: Require schema.org
        run: |
          grep -r "schema.org" . >/dev/null || echo "No schema.org found (warning)"

      - name: Validate robots/llms format
        run: |
          grep -q "User-Agent:" robots.txt || exit 1
          grep -q "User-Agent:" llms.txt || exit 1

      # =========================================================
      # SECURITY
      # =========================================================

      # only REAL mixed content (not SVG namespace!)
      - name: Block real HTTP links
        run: |
          bad=$(grep -rhoE 'href="http://|src="http://' . || true)
          if [ ! -z "$bad" ]; then
            echo "HTTP links found:"
            echo "$bad"
            exit 1
          fi

      # =========================================================
      # LINK TESTING
      # =========================================================

      - name: Test sitemap URLs
        run: |
          if [ -f sitemap.xml ]; then
            urls=$(grep -oP '(?<=<loc>).*?(?=</loc>)' sitemap.xml)
            for u in $urls; do
              echo "Testing $u"
              curl -Is --max-time 10 "$u" >/dev/null || echo "Broken: $u"
            done
          fi

      # =========================================================
      # INTEGRITY
      # =========================================================

      - name: Generate SHA256 checksums
        run: |
          find . -type f -not -path "./.git/*" -exec sha256sum {} \; > checksums.sha256

      # =========================================================
      # AI DATASET BUILD
      # =========================================================

      - name: Generate AI dataset
        run: |
          mkdir -p ai_dataset
          find . \( -name "*.json" -o -name "*.xml" -o -name "*.txt" -o -name "*.html" \) -exec cp {} ai_dataset/ \; 2>/dev/null || true
          tar -czf ai_dataset.tar.gz ai_dataset

      # =========================================================
      # ARTIFACTS
      # =========================================================

      - uses: actions/upload-artifact@v4
        with:
          name: site-build
          path: |
            checksums.sha256
            ai_dataset.tar.gz
